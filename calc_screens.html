<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>Inch Calc — Uniform Grid (420)</title>
<link href="https://use.typekit.net/iwc3riw.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js" defer></script>
<link rel="icon" href="calcicon.png" type="image/png" />
<link rel="apple-touch-icon" href="apple-touch-icon.png" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="Inch Calc" />

<style>
  /* ---------- Reset ---------- */
  *,*::before,*::after{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; background:#1f4d4d; color:#111;
    font-family:"aktiv-grotesk",-apple-system,system-ui,"Segoe UI",Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;
    display:flex; align-items:center; justify-content:center;
    padding:
      calc(env(safe-area-inset-top) + 10px)
      calc(env(safe-area-inset-right) + 10px)
      calc(env(safe-area-inset-bottom) + 10px)
      calc(env(safe-area-inset-left) + 10px);
    overflow:hidden; /* page never scrolls */
  }

  :root{
    --card-max: 420px;     /* designed scale cap */
    --gap: 10px;           /* unified spacing, set by JS */
    --tile: 56px;          /* unified button height, set by JS */
    --pad: var(--gap);

    --tape-min: 100px;
    --results-min: 60px;
    --results-max: 160px;  /* set by JS */

    /* theme */
    --card:#fff; --display-bg:#222; --display-text:#0f0;
    --num:#fffacd; --op:#f9a825; --frac:#64b5f6; --dec:#a5d6a7;
    --clear:#e57373; --mem:#64b5f6;
  }

  /* ---------- Card (stacked zones) ---------- */
  .card{
    width: clamp(320px, 100%, var(--card-max));
    height:100%;
    display:grid; gap:var(--gap);
    grid-template-rows:
      minmax(var(--tape-min), auto)
      minmax(var(--results-min), auto)
      auto
      auto
      auto;
    grid-template-areas:
      "tape" "results" "memory" "console" "fractions";
  }
  .panel{
    background:var(--card);
    border-radius:12px;
    box-shadow:0 8px 24px rgba(0,0,0,.15);
    overflow:hidden;
  }
  .pad{ padding:var(--pad) }

  /* ---------- Tape ---------- */
  .tape{ grid-area:tape; position:relative; min-height:var(--tape-min); }
  .tape-inner{ position:absolute; inset:0; border:1px solid #000;
    background:linear-gradient(to bottom,
      rgba(189,183,107,.3) 0%,
      rgba(255,215,0,.6) 6%,
      #ff0 25%,
      #ff0 75%,
      rgba(189,183,107,.6) 98%,
      rgba(255,215,0,.8) 100%); }
  .center-line{ position:absolute; top:18%; left:50%; width:5px; height:75%; background:red; transform:translateX(-50%); }
  .tick{ position:absolute; bottom:0; width:3px; background:#000; }
  .tick.small{height:15px} .tick.med{height:30px} .tick.lg{height:50px} .tick.num{height:70px}
  .tick-label{ position:absolute; bottom:70px; width:50px; text-align:center; transform:translateX(-50%); font-size:1.05em; }
  .sweep{ position:absolute; inset:0; pointer-events:none; }
  .sweep::before{ content:""; position:absolute; left:100%; top:0; width:100%; height:100%;
    background:linear-gradient(120deg, rgba(0,0,0,.08), rgba(0,0,0,.28) 50%, rgba(0,0,0,.08));
    transform:skewX(20deg); opacity:0; }
  @keyframes sweep { 0%{left:100%;opacity:.6} 100%{left:-100%;opacity:0} }
  .sweep.animate::before{ animation:sweep .8s ease-in-out forwards; }

  /* ---------- Results (only scroll area) ---------- */
  .results{ grid-area:results; background:var(--display-bg); color:var(--display-text); }
  .results .pad{ display:flex; flex-direction:column; gap:8px; }
  .history{ max-height:var(--results-max); overflow:auto; padding-right:4px; display:flex; flex-direction:column; gap:4px; }
  .row{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; line-height:1.25; white-space:normal; word-break:break-word; }
  .row.input{ letter-spacing:.04em; font-size:clamp(14px,1.9vw,18px); opacity:.9; }
  .output{ display:flex; justify-content:space-between; gap:8px; font-size:clamp(16px,2.2vw,22px); color:#bdfcb7; padding-top:6px; border-top:1px solid rgba(255,255,255,.1); }

  /* ---------- Memory (5×1 uniform) ---------- */
  .memory{ grid-area:memory }
  .memory-grid{ display:grid; gap:var(--gap);
    grid-template-columns:repeat(5, 1fr);
    grid-template-rows:var(--tile);
  }

  /* ---------- Console (one true grid 5×4) ---------- */
  .console{ grid-area:console }
  .console-grid{
    display:grid; gap:var(--gap);
    grid-template-columns:repeat(5, 1fr);
    grid-template-rows:repeat(4, var(--tile));
  }
  .r1{grid-row:1}.r2{grid-row:2}.r3{grid-row:3}.r4{grid-row:4}
  .c1{grid-column:1}.c2{grid-column:2}.c3{grid-column:3}.c4{grid-column:4}.c5{grid-column:5}

  /* ---------- Fractions (5×3 uniform) ---------- */
  .fractions{ grid-area:fractions }
  .fract-grid{
    display:grid; gap:var(--gap);
    grid-template-columns:repeat(5, 1fr);
    grid-template-rows:repeat(3, var(--tile));
  }

  /* ---------- Buttons ---------- */
  .btn{
    width:100%; height:100%;
    display:grid; place-items:center;
    border:0; border-radius:10px;
    font-weight:600; font-size:clamp(14px, calc(var(--tile)*.42), 20px);
    background:var(--num);
    box-shadow:0 2px 4px rgba(0,0,0,.2), inset 0 1px 0 rgba(255,255,255,.12);
    user-select:none; -webkit-tap-highlight-color:transparent;
  }
  .btn:active{ transform:scale(.98) }
  .btn.operator{ background:var(--op); color:#111 }
  .btn.frac{ background:var(--frac); color:#063c67 }
  .btn.dec{ background:var(--dec); color:#0c3a10 }
  .btn.clear,.btn.back{ background:var(--clear); color:#fff }
  .btn.mem{ background:var(--mem); color:#083f3f }
  .btn[disabled]{ opacity:.5; filter:saturate(.15) }
</style>
</head>
<body>

  <div id="card" class="card">

    <!-- Tape -->
    <div class="panel tape">
      <div class="tape-inner" id="tape">
        <div class="center-line"></div>
        <div class="sweep" id="sweep"></div>
      </div>
    </div>

    <!-- Results -->
    <div class="panel results">
      <div class="pad">
        <div class="history" id="history"><div class="row input" id="inputLine"></div></div>
        <div class="output"><div id="fractionLine"></div><div id="decimalLine"></div></div>
      </div>
    </div>

    <!-- Memory (5×1) -->
    <div class="panel memory pad">
      <div class="memory-grid">
        <button class="btn clear" data-action="mc">MC</button>
        <button class="btn mem" data-mem="0">M1</button>
        <button class="btn mem" data-mem="1">M2</button>
        <button class="btn mem" data-mem="2">M3</button>
        <button class="btn mem" data-mem="3">M4</button>
      </div>
    </div>

    <!-- Console (5×4 uniform) -->
    <div class="panel console pad">
      <div class="console-grid">
        <!-- Utility rail (col 1) -->
        <button class="btn clear r1 c1" data-action="clear">C</button>
        <button class="btn back  r2 c1" data-action="back">←</button>
        <button class="btn       r3 c1" id="menuBtn">menu</button>
        <button class="btn operator r4 c1" id="feetBtn">Feet</button>

        <!-- Numbers (cols 2–4) -->
        <button class="btn r1 c2" data-val="7">7</button>
        <button class="btn r1 c3" data-val="8">8</button>
        <button class="btn r1 c4" data-val="9">9</button>

        <button class="btn r2 c2" data-val="4">4</button>
        <button class="btn r2 c3" data-val="5">5</button>
        <button class="btn r2 c4" data-val="6">6</button>

        <button class="btn r3 c2" data-val="1">1</button>
        <button class="btn r3 c3" data-val="2">2</button>
        <button class="btn r3 c4" data-val="3">3</button>

        <button class="btn r4 c2" data-val="0">0</button>
        <button class="btn dec r4 c3" data-val=".">.</button>
        <button class="btn r4 c4" disabled></button>

        <!-- Operator rail (col 5) -->
        <button class="btn operator r1 c5" data-op="+">+</button>
        <button class="btn operator r2 c5" data-op="-">−</button>
        <button class="btn operator r3 c5" data-op="*">×</button>
        <button class="btn operator r4 c5" data-op="/">÷</button>
      </div>
    </div>

    <!-- Fractions (5×3 uniform) -->
    <div class="panel fractions pad">
      <div class="fract-grid">
        <button class="btn frac" data-frac="1/16">1/16</button>
        <button class="btn frac" data-frac="1/8">1/8</button>
        <button class="btn frac" data-frac="3/16">3/16</button>
        <button class="btn frac" data-frac="1/4">1/4</button>
        <button class="btn frac" data-frac="5/16">5/16</button>

        <button class="btn frac" data-frac="3/8">3/8</button>
        <button class="btn frac" data-frac="7/16">7/16</button>
        <button class="btn frac" data-frac="1/2">1/2</button>
        <button class="btn frac" data-frac="9/16">9/16</button>
        <button class="btn frac" data-frac="5/8">5/8</button>

        <button class="btn frac" data-frac="11/16">11/16</button>
        <button class="btn frac" data-frac="3/4">3/4</button>
        <button class="btn frac" data-frac="13/16">13/16</button>
        <button class="btn frac" data-frac="7/8">7/8</button>
        <button class="btn frac" data-frac="15/16">15/16</button>
      </div>
    </div>
  </div>

  <!-- Minimal modal -->
  <div id="modal" style="position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:30;">
    <div style="background:#fffdee; color:#222; max-width:min(680px, 92vw); max-height:min(80vh, 700px); overflow:auto; border-radius:12px; padding:16px 18px; box-shadow:0 12px 40px rgba(0,0,0,.45);">
      <h2 style="margin-top:0">Calculator Instructions</h2>
      <ul>
        <li>Enter numbers with the keypad; tap fractions for inch fractions.</li>
        <li>Operators: + − × ÷ (orange rail on the right).</li>
        <li>Feet Mode: enter a whole number, then tap <b>Feet</b>.</li>
        <li>← removes last digit/operator; C clears everything.</li>
        <li>M1–M4: tap to insert; double-tap or long-press to store; MC clears memory.</li>
        <li>Only the results panel scrolls when content is long.</li>
      </ul>
      <div style="text-align:right; margin-top:8px;">
        <button id="closeModal" style="background:#111; color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer;">Close</button>
      </div>
    </div>
  </div>

<script>
(() => {
  'use strict';

  /* ====== Uniform tile/gap solver ======
     Memory 5×1, Console 5×4, Fractions 5×3
     One tile height for all rows. Only Results scrolls. */
  const MIN_TAP = 44;
  const MIN_GAP = 6, MAX_GAP = 12;

  const setVar = (k,v) => document.documentElement.style.setProperty(k,v);
  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
  const cssNum = (name, fallback) => {
    const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    const n = parseFloat(v); return Number.isFinite(n) ? n : fallback;
  };

  function computeTile(){
    const card = document.getElementById('card');
    const { width: W, height: H } = card.getBoundingClientRect();

    let gap = clamp(Math.floor(Math.min(W,H) * 0.02), MIN_GAP, MAX_GAP);
    setVar('--gap', gap + 'px');

    const tapeMin = cssNum('--tape-min', 100);
    const resultsMin = cssNum('--results-min', 60);

    // Height available for keypad stack (memory + console + fractions) minus the single grid gap above memory
    const H_for_keypad = Math.max(0, H - tapeMin - resultsMin - gap);

    // Keypad composition:
    // rows = 1 (memory) + 4 (console) + 3 (fractions) = 8
    // gaps:
    //  - internal console row gaps: 3×gap
    //  - internal fractions row gaps: 2×gap
    //  - card gaps between memory/console & console/fractions: 2×gap
    //  - panel paddings (top+bottom) for each of the three panels: 6×gap
    const ROWS = 8;
    const GAP_BUDGET = (3 + 2 + 2 + 6) * gap; // = 13 * gap

    // Height-derived tile:
    let tileFromH = Math.floor((H_for_keypad - GAP_BUDGET) / ROWS);

    // Width-derived tile (inside panel padding left+right = 2×gap):
    const W_inside = W - 2*gap;
    let tileFromW = Math.floor((W_inside - (5 - 1) * gap) / 5);

    let tile = Math.max(MIN_TAP, Math.min(tileFromH, tileFromW));

    // Compute results max height leftover (min 60)
    const keypadHeight = ROWS*tile + GAP_BUDGET;
    const resultsMax = Math.max(60, H_for_keypad - keypadHeight);

    setVar('--tile', tile + 'px');
    setVar('--results-max', resultsMax + 'px');
  }

  const ro = new ResizeObserver(computeTile);
  ro.observe(document.getElementById('card'));
  window.addEventListener('resize', computeTile);
  window.addEventListener('orientationchange', () => setTimeout(computeTile, 60));

  /* ====== Calculator logic (preserved) ====== */
  const tape = document.getElementById('tape');
  const sweep = document.getElementById('sweep');
  const inputLine = document.getElementById('inputLine');
  const fractionLine = document.getElementById('fractionLine');
  const decimalLine = document.getElementById('decimalLine');

  const MEMORY_KEY = 'calcMemorySlots_uniform420';
  let memorySlots = [null,null,null,null];

  let tokens = [];
  let currentEntry = '';
  let feetBase = null; // inches
  let tmr = null;
  const PPI = 160;

  const gcd = (a,b)=> (b?gcd(b,a%b):Math.abs(a));
  const isOp = t => ['+','-','*','/'].includes(t);
  const isWhole = s => /^-?\d+$/.test(s);
  const splitDec = s => { const [w, d='0'] = s.split('.'); return [parseInt(w,10), parseFloat('0.'+d)]; };
  const fracFromDec = d => { const D=16; let n=Math.round(d*D), g=gcd(n,D); return `${n/g}/${D/g}`; };

  function formatResult(value){
    const r = Math.round(value*16)/16;
    const w = Math.floor(Math.abs(r));
    const f = Math.abs(r) - w;
    let n = Math.round(f*16), d = 16, g = gcd(n,d); n/=g; d/=g;
    let s = (d===1 || n===0) ? `${w}"` : (w ? `${w} ${n}/${d}"` : `${n}/${d}"`);
    if (r<0) s = `-${s}`;
    return { fraction:s, decimal:`${r.toFixed(4)}"` };
  }

  function updateInput(){
    let s='';
    tokens.forEach(t=>{
      if (/^-?\d+\.\d+$/.test(t)) { const [w,f]=splitDec(t); s += f>0 ? `${w} ${fracFromDec(f)} ` : `${w} `; }
      else s += `${t} `;
    });
    if (currentEntry) s += `${currentEntry} `;
    inputLine.textContent = s.trim();
  }

  function evaluate(){
    const expr = [...tokens, currentEntry].filter(Boolean);
    if (!expr.length || isOp(expr.at(-1))) return;
    try{
      const raw = math.evaluate(expr.join(' '));
      let num = typeof raw === 'number' ? raw : raw.toNumber();
      if (feetBase != null) num += feetBase;
      const out = formatResult(num);
      fractionLine.textContent = out.fraction;
      decimalLine.textContent  = out.decimal;
      drawTape(num);
    }catch{
      fractionLine.textContent = '';
      decimalLine.textContent  = '';
    }
  }
  const qEval = () => { clearTimeout(tmr); tmr = setTimeout(evaluate, 120); };

  // Tape rendering
  function drawTape(center){
    if (center<0) center=0;
    [...tape.querySelectorAll('.tick,.tick-label')].forEach(n=>n.remove());
    const rect = tape.getBoundingClientRect();
    const mid = rect.width/2;
    const range = 3;
    const start = Math.max(center - range/2, 0), end = center + range/2;
    const a = Math.floor(start*16), b = Math.ceil(end*16);
    for (let i=a;i<=b;i++){
      const inches = i/16;
      const x = (inches - center)*PPI + mid - 1.5;
      const el = document.createElement('div'); el.className='tick'; el.style.left = x+'px';
      if (i%16===0){ el.classList.add('num'); const lbl=document.createElement('div'); lbl.className='tick-label'; lbl.textContent=inches.toFixed(0); lbl.style.left=(x+1.5)+'px'; tape.appendChild(lbl); }
      else if (i%8===0) el.classList.add('lg'); else if (i%4===0) el.classList.add('med'); else el.classList.add('small');
      tape.appendChild(el);
    }
    sweep.classList.remove('animate'); void sweep.offsetWidth; sweep.classList.add('animate');
  }

  // Memory helpers
  function loadMemory(){ try{ const s=localStorage.getItem(MEMORY_KEY); if (s) memorySlots = JSON.parse(s);}catch{} refreshMemLabels(); }
  function saveMemory(){ localStorage.setItem(MEMORY_KEY, JSON.stringify(memorySlots)); }
  function refreshMemLabels(){
    document.querySelectorAll('.btn.mem').forEach(btn=>{
      const i=+btn.dataset.mem, v=memorySlots[i];
      btn.textContent = v==null ? `M${i+1}` : formatResult(v).fraction.replace('"','');
    });
  }

  // Bind numbers/decimal
  document.querySelectorAll('.btn[data-val]').forEach(b=>b.addEventListener('click',()=>{
    currentEntry += b.dataset.val; updateInput(); qEval();
  }));
  document.querySelector('.btn.dec[data-val="."]').addEventListener('click',()=>{
    if (currentEntry.includes('.')) return;
    currentEntry = currentEntry ? currentEntry+'.' : '0.';
    updateInput(); qEval();
  });

  // Operators
  document.querySelectorAll('.btn.operator[data-op]').forEach(b=>b.addEventListener('click',()=>{
    const op = b.dataset.op;
    if (currentEntry){ tokens.push(currentEntry); currentEntry=''; }
    if (!tokens.length && op !== '-') return;
    if (isOp(tokens.at(-1))) tokens[tokens.length-1] = op;
    else tokens.push(op);
    updateInput(); qEval();
  }));

  // Backspace / Clear
  document.querySelector('.btn.back').addEventListener('click',()=>{
    if (currentEntry) currentEntry = currentEntry.slice(0,-1);
    else if (tokens.length){
      let last = tokens.at(-1);
      if (isOp(last)) tokens.pop();
      else {
        last = last.slice(0,-1);
        if (last) tokens[tokens.length-1]=last; else tokens.pop();
      }
    }
    updateInput(); evaluate();
  });
  document.querySelector('.btn.clear[data-action="clear"]').addEventListener('click',()=>{
    tokens=[]; currentEntry=''; feetBase=null;
    inputLine.textContent=''; fractionLine.textContent=''; decimalLine.textContent='';
    drawTape(0);
  });

  // Feet mode
  document.getElementById('feetBtn').addEventListener('click',()=>{
    if (currentEntry && isWhole(currentEntry)){
      const feet = parseInt(currentEntry,10);
      feetBase = feet * 12;  // inches
      tokens=[]; currentEntry='';
      inputLine.textContent='';
      const out = formatResult(feetBase);
      fractionLine.textContent = `${feet}" base`;
      decimalLine.textContent  = out.decimal;
      drawTape(feetBase);
    } else {
      alert('Enter a whole number before pressing Feet.');
    }
  });

  // Memory buttons
  document.querySelectorAll('.btn.mem').forEach(btn=>{
    // Insert on tap
    btn.addEventListener('click',()=>{
      const i=+btn.dataset.mem, v=memorySlots[i]; if (v==null) return;
      if (currentEntry) tokens.push(currentEntry);
      currentEntry = String(v);
      updateInput(); evaluate();
    });
    // Store on double-click
    btn.addEventListener('dblclick',()=>{
      const i=+btn.dataset.mem; const expr=[...tokens, currentEntry].filter(Boolean);
      if (!expr.length || isOp(expr.at(-1))) return;
      const raw = math.evaluate(expr.join(' '));
      const val = typeof raw==='number' ? raw : raw.toNumber();
      const confirmReplace = memorySlots[i]!=null ? confirm(`M${i+1} has ${formatResult(memorySlots[i]).fraction}. Replace?`) : true;
      if (!confirmReplace) return;
      memorySlots[i]= val + (feetBase||0);
      saveMemory(); refreshMemLabels();
    });
    // Long-press → store (touch)
    let timer=null;
    btn.addEventListener('touchstart',()=>{ timer=setTimeout(()=>btn.dispatchEvent(new Event('dblclick')),600); }, {passive:true});
    btn.addEventListener('touchend',()=>clearTimeout(timer), {passive:true});
  });
  document.querySelector('.btn.clear[data-action="mc"]').addEventListener('click',()=>{
    if (!confirm('Clear all memory slots?')) return;
    memorySlots=[null,null,null,null]; saveMemory(); refreshMemLabels();
  });

  // Fractions
  document.querySelectorAll('.btn.frac').forEach(b=>b.addEventListener('click',()=>{
    const f=b.dataset.frac;
    if (!currentEntry) currentEntry=f;
    else if (isWhole(currentEntry)){
      const [n,d]=f.split('/').map(Number);
      const combined = parseInt(currentEntry,10) + (n/d);
      tokens.push(String(combined)); currentEntry='';
    } else if (isOp(tokens.at(-1))) {
      currentEntry += f;
    } else {
      tokens.push(currentEntry); tokens.push('+'); currentEntry=f;
    }
    updateInput(); qEval();
  }));

  // Modal
  const modal=document.getElementById('modal');
  document.getElementById('menuBtn').addEventListener('click',()=>{ modal.style.display='flex'; });
  document.getElementById('closeModal').addEventListener('click',()=>{ modal.style.display='none'; });
  modal.addEventListener('click',e=>{ if(e.target===modal) modal.style.display='none'; });

  // Prevent body scroll, allow results scroll
  document.addEventListener('touchmove', e=>{
    if (e.target.closest('.history') || e.target.closest('#modal')) return;
    e.preventDefault();
  }, {passive:false});

  // Init
  function initTape(){ const r=tape.getBoundingClientRect(); if(!r.width){ requestAnimationFrame(initTape); return; } drawTape(0); }
  computeTile();
  initTape();
  loadMemory();

})();
</script>
</body>
</html>
